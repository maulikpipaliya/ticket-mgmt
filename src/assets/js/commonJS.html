<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
  integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>


<script src="//cdn.quilljs.com/1.3.6/quill.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="//cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>

<script>
  var select = (selector, all = false) => {
        return all
            ? [...document.querySelectorAll(selector)]
            : document.querySelector(selector)
    }

    var on = (element, event, callback, all = false) => {
        if (all) {
            select(element, true).forEach((el) =>
                el.addEventListener(event, callback)
            )
        } else {
            select(element).addEventListener(event, callback)
        }
    }

    var addClass = (element, className) => {
        select(element).classList.add(className)
    }

    var removeClass = (element, className) => {
        select(element).classList.remove(className)
    }

    var toggleClass = (element, className) => {
        select(element).classList.toggle(className)
    }

</script>

<script>
  console.log("script.js loaded");

    if (select(".fi-btn-toggle-sidebar")) {
        console.log("hahah");
        on(".fi-btn-toggle-sidebar", "click", function (e) {
            console.log("click");
            select("body").classList.toggle("toggle-sidebar");
        });
    }

    if (select(".quill-editor-full")) {
        console.log("Maulik");
        var quill = new Quill("#full-editor", {
            modules: {
                toolbar: [[{ header: [1, 2, false] }], ["bold", "italic", "underline"], ["code-block"]],
            },
            theme: "snow",
        });
    }

    $(document).ready(function () {
        // Setup - add a text input to each footer cell
        $("#ticket-master-table thead tr").clone(true).addClass("filters").appendTo("#ticket-master-table thead");

        var table = $("#ticket-master-table").DataTable({
            orderCellsTop: true,
            fixedHeader: true,
            initComplete: function () {
                var api = this.api();

                // For each column
                api
                    .columns()
                    .eq(0)
                    .each(function (colIdx) {
                        // Set the header cell to contain the input element
                        var cell = $(".filters th").eq($(api.column(colIdx).header()).index());
                        var title = $(cell).text();
                        $(cell).html('<input type="text" placeholder="' + title + '" />');

                        // On every keypress in this input
                        $("input", $(".filters th").eq($(api.column(colIdx).header()).index()))
                            .off("keyup change")
                            .on("keyup change", function (e) {
                                e.stopPropagation();

                                // Get the search value
                                $(this).attr("title", $(this).val());
                                var regexr = "({search})"; //$(this).parents('th').find('select').val();

                                var cursorPosition = this.selectionStart;
                                // Search the column for that value
                                api
                                    .column(colIdx)
                                    .search(this.value != "" ? regexr.replace("{search}", "(((" + this.value + ")))") : "", this.value != "", this.value == "")
                                    .draw();

                                // $(this).focus()[0].setSelectionRange(cursorPosition, cursorPosition);
                            });
                    });
            },
        });
    });


    function goToTicketURL(ticketId){
        let scriptURL;
        google.script.run.withSuccessHandler((url)=>{
          scriptURL = url;
          redirectToURL(scriptURL + '?path=viewTicket&ticketId=' + ticketId)
        }).getScriptURL();
    }

    $("#tbHeaderTicketSearch").on("keypress", function(e){
      
      console.log(e)
      const textBoxValue = $("#tbHeaderTicketSearch").val().toString().trim();

      let scriptURL;
      if (e.which === 13){
        showLoader();
        goToTicketURL(textBoxValue);
      }
    })


    $("#btnHeaderTicketSearch").on("click", function(e){
      e.preventDefault();
      const textBoxValue = $("#tbHeaderTicketSearch").val().toString().trim();
      goToTicketURL(textBoxValue);
    })


    function showLoader(){
      $("main").empty()
      $("main").prepend('<div class="lds-ripple"><div></div><div></div></div>')
    }

    $("#btnCopy").on("click", (e)=>{
      console.log("Copy");

          /* Get the text field */
      var copyText = $("#ticketId");

      /* Select the text field */
      copyText.select();

      /* Copy the text inside the text field */
      navigator.clipboard.writeText(copyText.val());

      $("#btnCopy").text("Copied");
    })
    

</script>


<script>
  function redirectToURL(url){
    var link = document.createElement('a');
    link.href = url;
    link.id = 'linkURL';
    document.body.appendChild(link);
    console.log("Redirecting to " + link.href);
    document.getElementById("linkURL").click();  
  }

  function getUserInfo() {
    let userInfo;
    var user = google.script.run.withSuccessHandler(function(response) {
        userInfo = response;
        console.log("userInfo");
        console.log(userInfo);
        return userInfo;
        // document.getElementById("username").innerText = response;
    }).withFailureHandler(()=>{}).getActiveUserInfo();
  }
    

</script>